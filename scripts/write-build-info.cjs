const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const rootDir = path.resolve(__dirname, "..");
const packageJsonPath = path.join(rootDir, "package.json");
const buildInfoPath = path.join(rootDir, "src", "quartermaster", "build-info.ts");

const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
const version = packageJson.version ?? "0.0.0";
let commit = "unknown";

try {
	commit = execSync("git rev-parse --short HEAD", { encoding: "utf8" }).trim();
} catch (error) {
	console.warn("Unable to resolve git commit for build info:", error.message);
}

const content = `// This file is generated by scripts/write-build-info.cjs
export const BUILD_INFO = {
\tversion: ${JSON.stringify(version)},
\tcommit: ${JSON.stringify(commit)}
};
`;

fs.mkdirSync(path.dirname(buildInfoPath), { recursive: true });
fs.writeFileSync(buildInfoPath, content, "utf8");
